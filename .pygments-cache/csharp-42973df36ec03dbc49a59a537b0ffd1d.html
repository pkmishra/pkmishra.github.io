<div class="highlight"><pre><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">Util</span>
<span class="p">{</span>
<span class="k">public</span> <span class="k">static</span> <span class="n">DataTable</span> <span class="nf">ToDataTable</span><span class="p">(</span><span class="k">this</span> <span class="n">IEnumerable</span> <span class="n">varlist</span><span class="p">,</span> <span class="n">CreateRowDelegate</span> <span class="n">fn</span><span class="p">)</span>
<span class="p">{</span>
<span class="n">DataTable</span> <span class="n">dtReturn</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DataTable</span><span class="p">();</span>
<span class="c1">// column names</span>
<span class="n">PropertyInfo</span><span class="p">[]</span> <span class="n">oProps</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
<span class="c1">// Could add a check to verify that there is an element 0</span>
<span class="k">foreach</span> <span class="p">(</span><span class="n">T</span> <span class="n">rec</span> <span class="k">in</span> <span class="n">varlist</span><span class="p">)</span>
<span class="p">{</span>
<span class="c1">// Use reflection to get property names, to create table, Only first time, others will follow</span>
<span class="k">if</span> <span class="p">(</span><span class="n">oProps</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
<span class="n">oProps</span> <span class="p">=</span> <span class="p">((</span><span class="n">Type</span><span class="p">)</span><span class="n">rec</span><span class="p">.</span><span class="n">GetType</span><span class="p">()).</span><span class="n">GetProperties</span><span class="p">();</span>
<span class="k">foreach</span> <span class="p">(</span><span class="n">PropertyInfo</span> <span class="n">pi</span> <span class="k">in</span> <span class="n">oProps</span><span class="p">)</span>
<span class="p">{</span>
<span class="c1">// Note that we must check a nullable type else method will throw and error</span>
<span class="n">Type</span> <span class="n">colType</span> <span class="p">=</span> <span class="n">pi</span><span class="p">.</span><span class="n">PropertyType</span><span class="p">;</span> <span class="k">if</span> <span class="p">((</span><span class="n">colType</span><span class="p">.</span><span class="n">IsGenericType</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">colType</span><span class="p">.</span><span class="n">GetGenericTypeDefinition</span><span class="p">()</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Nullable</span><span class="p">)))</span>
<span class="p">{</span>
<span class="c1">// Since all the elements have same type you can just take the first element and get type</span>
<span class="n">colType</span> <span class="p">=</span> <span class="n">colType</span><span class="p">.</span><span class="n">GetGenericArguments</span><span class="p">()[</span><span class="m">0</span><span class="p">];</span>
<span class="p">}</span>
<span class="n">dtReturn</span><span class="p">.</span><span class="n">Columns</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">DataColumn</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">colType</span><span class="p">));</span>
<span class="p">}</span>
<span class="p">}</span>
<span class="n">DataRow</span> <span class="n">dr</span> <span class="p">=</span> <span class="n">dtReturn</span><span class="p">.</span><span class="n">NewRow</span><span class="p">();</span>
<span class="c1">//Iterate through each property in PropertyInfo</span>
<span class="k">foreach</span> <span class="p">(</span><span class="n">PropertyInfo</span> <span class="n">pi</span> <span class="k">in</span> <span class="n">oProps</span><span class="p">)</span>
<span class="p">{</span>
<span class="c1">// Handle null values accordingly</span>
<span class="n">dr</span><span class="p">[</span><span class="n">pi</span><span class="p">.</span><span class="n">Name</span><span class="p">]</span> <span class="p">=</span> <span class="n">pi</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span> <span class="p">==</span> <span class="k">null</span> <span class="p">?</span> <span class="n">DBNull</span><span class="p">.</span><span class="n">Value</span> <span class="p">:</span> <span class="n">pi</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">dtReturn</span><span class="p">.</span><span class="n">Rows</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">dr</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">return</span> <span class="p">(</span><span class="n">dtReturn</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">public</span> <span class="k">delegate</span> <span class="kt">object</span><span class="p">[]</span> <span class="nf">CreateRowDelegate</span><span class="p">(</span><span class="n">T</span> <span class="n">t</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">Changes</span> <span class="k">in</span> <span class="n">the</span> <span class="n">Select</span> <span class="n">method</span>

<span class="k">public</span> <span class="n">ISingleResult</span> <span class="nf">SelectMethod</span><span class="p">(){</span>
<span class="c1">//Get DAL Instance DALInstance</span>
<span class="k">return</span> <span class="n">DALInstance</span><span class="p">.</span><span class="n">GetSomeData</span><span class="p">(){}</span>
<span class="p">}</span>
<span class="k">public</span> <span class="n">DataTable</span> <span class="nf">GetSomeData</span><span class="p">()</span>
<span class="p">{</span>
<span class="n">ISingle</span> <span class="n">result</span> <span class="p">=</span> <span class="c1">//code to get result;</span>
<span class="k">return</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">ToDataTable</span><span class="p">(</span><span class="n">rec</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="kt">object</span><span class="p">[]</span> <span class="p">{</span> <span class="n">result</span><span class="p">}));</span>
<span class="p">}</span>
</pre></div>